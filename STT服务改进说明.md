# STTæœåŠ¡æ”¹è¿›è¯´æ˜

## ğŸ” **åŸæœ‰STTæœåŠ¡é—®é¢˜åˆ†æ**

### **1. ç¼ºå¤±çš„å…³é”®åŠŸèƒ½**

#### **éŸ³é¢‘å¤„ç†åŠŸèƒ½**
- âŒ **éŸ³é¢‘æ ¼å¼éªŒè¯** - æ²¡æœ‰éªŒè¯PCMéŸ³é¢‘æ•°æ®æ ¼å¼
- âŒ **éŸ³é¢‘ç¼“å†²ç®¡ç†** - æ²¡æœ‰éŸ³é¢‘æ•°æ®ç¼“å†²æœºåˆ¶
- âŒ **éŸ³é¢‘é¢„å¤„ç†** - æ²¡æœ‰é™å™ªã€å¢ç›Šæ§åˆ¶ç­‰
- âŒ **éŸ³é¢‘æ ¼å¼è½¬æ¢** - æ²¡æœ‰å¤„ç†ä¸åŒéŸ³é¢‘æ ¼å¼

#### **è¿æ¥ç®¡ç†åŠŸèƒ½**
- âŒ **è¿æ¥é‡è¯•æœºåˆ¶** - è¿æ¥å¤±è´¥åæ²¡æœ‰è‡ªåŠ¨é‡è¯•
- âŒ **è¿æ¥å¥åº·æ£€æŸ¥** - æ²¡æœ‰å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
- âŒ **è‡ªåŠ¨é‡è¿** - è¿æ¥æ–­å¼€åæ²¡æœ‰è‡ªåŠ¨é‡è¿
- âŒ **å¿ƒè·³æœºåˆ¶** - æ²¡æœ‰ä¿æŒè¿æ¥æ´»è·ƒçš„å¿ƒè·³

#### **ä¼šè¯ç®¡ç†åŠŸèƒ½**
- âŒ **ä¼šè¯çŠ¶æ€ç®¡ç†** - æ²¡æœ‰ä¼šè¯IDå’ŒçŠ¶æ€è·Ÿè¸ª
- âŒ **ä¼šè¯å†å²è®°å½•** - æ²¡æœ‰ä¿å­˜ä¼šè¯å†å²
- âŒ **ä¼šè¯é…ç½®** - æ²¡æœ‰çµæ´»çš„ä¼šè¯é…ç½®é€‰é¡¹

#### **é”™è¯¯å¤„ç†åŠŸèƒ½**
- âŒ **é”™è¯¯æ¢å¤æœºåˆ¶** - æ²¡æœ‰é”™è¯¯åçš„è‡ªåŠ¨æ¢å¤
- âŒ **é”™è¯¯åˆ†ç±»å¤„ç†** - æ²¡æœ‰ä¸åŒç±»å‹çš„é”™è¯¯å¤„ç†
- âŒ **é”™è¯¯ç»Ÿè®¡** - æ²¡æœ‰é”™è¯¯ç»Ÿè®¡å’Œç›‘æ§

#### **ç›‘æ§å’Œç»Ÿè®¡åŠŸèƒ½**
- âŒ **æ€§èƒ½ç›‘æ§** - æ²¡æœ‰è¯†åˆ«æ€§èƒ½ç»Ÿè®¡
- âŒ **è¿æ¥ç»Ÿè®¡** - æ²¡æœ‰è¿æ¥çŠ¶æ€ç»Ÿè®¡
- âŒ **éŸ³é¢‘ç»Ÿè®¡** - æ²¡æœ‰éŸ³é¢‘æ•°æ®å¤„ç†ç»Ÿè®¡

### **2. åè®®å¤„ç†ä¸å®Œæ•´**

#### **æ¶ˆæ¯ç±»å‹å¤„ç†**
- âŒ **ä¸­é—´ç»“æœå¤„ç†** - æ²¡æœ‰å¤„ç†interimç»“æœ
- âŒ **ä¼šè¯çŠ¶æ€æ¶ˆæ¯** - æ²¡æœ‰å¤„ç†ä¼šè¯å¼€å§‹/ç»“æŸ
- âŒ **é”™è¯¯æ¶ˆæ¯å¤„ç†** - é”™è¯¯æ¶ˆæ¯å¤„ç†ä¸å®Œæ•´
- âŒ **å¿ƒè·³æ¶ˆæ¯** - æ²¡æœ‰å¿ƒè·³æ¶ˆæ¯å¤„ç†

#### **éŸ³é¢‘æ•°æ®æ ¼å¼**
- âŒ **Base64ç¼–ç ** - éŸ³é¢‘æ•°æ®æ²¡æœ‰æ­£ç¡®ç¼–ç 
- âŒ **éŸ³é¢‘æ ¼å¼éªŒè¯** - æ²¡æœ‰éªŒè¯éŸ³é¢‘æ•°æ®æ ¼å¼
- âŒ **éŸ³é¢‘å¤§å°é™åˆ¶** - æ²¡æœ‰éŸ³é¢‘æ•°æ®å¤§å°é™åˆ¶

## âœ… **æ”¹è¿›åçš„STTæœåŠ¡åŠŸèƒ½**

### **1. å¢å¼ºçš„éŸ³é¢‘å¤„ç†**

#### **éŸ³é¢‘éªŒè¯åŠŸèƒ½**
```python
class AudioProcessor:
    @staticmethod
    def validate_pcm_audio(audio_data: bytes, sample_rate: int = 16000, channels: int = 1) -> bool:
        """éªŒè¯PCMéŸ³é¢‘æ•°æ®æ ¼å¼"""
        # æ£€æŸ¥æ•°æ®é•¿åº¦æ˜¯å¦ä¸ºå¶æ•°ï¼ˆ16ä½é‡‡æ ·ï¼‰
        # æ£€æŸ¥æ•°æ®é•¿åº¦æ˜¯å¦åˆç†
        # è¿”å›éªŒè¯ç»“æœ
```

#### **éŸ³é¢‘ç¼“å†²ç®¡ç†**
```python
# éŸ³é¢‘ç¼“å†²
self.audio_buffer = deque(maxlen=1000)  # æœ€å¤šç¼“å†²1000ä¸ªéŸ³é¢‘å—
self.buffer_size = 0
```

### **2. å®Œå–„çš„è¿æ¥ç®¡ç†**

#### **è¿æ¥çŠ¶æ€ç®¡ç†**
```python
class STTStatus(Enum):
    """STTçŠ¶æ€æšä¸¾"""
    DISCONNECTED = "disconnected"
    CONNECTING = "connecting"
    CONNECTED = "connected"
    RECOGNIZING = "recognizing"
    ERROR = "error"
```

#### **è‡ªåŠ¨é‡è¿æœºåˆ¶**
```python
async def _reconnect_loop(self) -> None:
    """é‡è¿å¾ªç¯"""
    # æŒ‡æ•°é€€é¿é‡è¿ç­–ç•¥
    # æœ€å¤§é‡è¿æ¬¡æ•°é™åˆ¶
    # é‡è¿çŠ¶æ€é€šçŸ¥
```

#### **å¥åº·æ£€æŸ¥åŠŸèƒ½**
```python
async def health_check(self) -> bool:
    """æ‰§è¡Œå¥åº·æ£€æŸ¥"""
    # æ£€æŸ¥WebSocketçŠ¶æ€
    # æ£€æŸ¥æœ€åæ´»åŠ¨æ—¶é—´
    # å‘é€pingæµ‹è¯•
```

### **3. å®Œæ•´çš„ä¼šè¯ç®¡ç†**

#### **ä¼šè¯ä¿¡æ¯è·Ÿè¸ª**
```python
@dataclass
class STTSession:
    """STTä¼šè¯ä¿¡æ¯"""
    session_id: str
    start_time: float
    config: STTConfig
    status: STTStatus
    total_audio_bytes: int = 0
    total_results: int = 0
    final_results: int = 0
    errors: List[str] = None
```

#### **ä¼šè¯é…ç½®ç®¡ç†**
```python
@dataclass
class STTConfig:
    """STTé…ç½®ç±»"""
    audio_format: str = "pcm"
    sample_rate: int = 16000
    channels: int = 1
    language: str = "zh-CN"
    enable_punctuation: bool = True
    enable_itn: bool = True
    enable_interim: bool = True
    vad_enable: bool = True
```

### **4. å¢å¼ºçš„é”™è¯¯å¤„ç†**

#### **é”™è¯¯åˆ†ç±»å¤„ç†**
```python
# å¤„ç†ä¸åŒç±»å‹çš„é”™è¯¯
elif message_type == "error":
    error_msg = data.get("message", "Unknown error")
    error_code = data.get("code", 0)
    
    self.current_session.errors.append(error_msg)
    self.stats["total_errors"] += 1
    
    if self.on_error:
        self.on_error(f"STT Error {error_code}: {error_msg}")
```

#### **é”™è¯¯æ¢å¤æœºåˆ¶**
```python
# è¿æ¥æ–­å¼€è‡ªåŠ¨é‡è¿
except websockets.exceptions.ConnectionClosed:
    logger.warning("STT connection closed during recognition")
    # è§¦å‘é‡è¿æœºåˆ¶
    break
```

### **5. å®Œå–„çš„ç›‘æ§å’Œç»Ÿè®¡**

#### **ç»Ÿè®¡ä¿¡æ¯æ”¶é›†**
```python
self.stats = {
    "total_sessions": 0,
    "total_audio_bytes": 0,
    "total_results": 0,
    "total_errors": 0,
    "connection_time": 0,
    "last_activity": 0
}
```

#### **æ€§èƒ½ç›‘æ§API**
```python
@app.get("/api/stt/status")
async def get_stt_status():
    """è·å–STTå®¢æˆ·ç«¯çŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯"""
    stats = stt_client.get_stats()
    health_status = await stt_client.health_check()
    return {"success": True, "stats": stats, "health_check": health_status}
```

### **6. å®Œæ•´çš„åè®®å¤„ç†**

#### **æ¶ˆæ¯ç±»å‹å¤„ç†**
```python
# å¤„ç†æœ€ç»ˆè¯†åˆ«ç»“æœ
if message_type == "result":
    text = data.get("text", "")
    is_final = data.get("is_final", True)
    confidence = data.get("confidence", 0.0)

# å¤„ç†ä¸­é—´è¯†åˆ«ç»“æœ
elif message_type == "interim":
    text = data.get("text", "")
    confidence = data.get("confidence", 0.0)

# å¤„ç†é”™è¯¯æ¶ˆæ¯
elif message_type == "error":
    error_msg = data.get("message", "Unknown error")
    error_code = data.get("code", 0)

# å¤„ç†ä¼šè¯ç»“æŸ
elif message_type == "session_end":
    logger.info(f"STT session ended: {self.current_session.session_id}")
    break
```

#### **éŸ³é¢‘æ•°æ®ç¼–ç **
```python
audio_message = {
    "type": "audio",
    "session_id": self.current_session.session_id,
    "audio_data": base64.b64encode(audio_data).decode('utf-8'),
    "audio_format": "pcm"
}
```

## ğŸš€ **æ–°å¢APIç«¯ç‚¹**

### **1. çŠ¶æ€æŸ¥è¯¢API**
```python
GET /api/stt/status
# è·å–STTå®¢æˆ·ç«¯çŠ¶æ€å’Œç»Ÿè®¡ä¿¡æ¯
```

### **2. é‡è¿API**
```python
POST /api/stt/reconnect
# æ‰‹åŠ¨é‡è¿STTå®¢æˆ·ç«¯
```

### **3. ç¼“å†²æ¸…ç†API**
```python
POST /api/stt/clear_buffer
# æ¸…ç©ºSTTéŸ³é¢‘ç¼“å†²
```

### **4. ä¼šè¯å†å²API**
```python
GET /api/stt/sessions
# è·å–STTä¼šè¯å†å²
```

## ğŸ“Š **æ”¹è¿›æ•ˆæœå¯¹æ¯”**

| åŠŸèƒ½ | åŸæœ‰ç‰ˆæœ¬ | æ”¹è¿›ç‰ˆæœ¬ |
|------|----------|----------|
| éŸ³é¢‘éªŒè¯ | âŒ æ—  | âœ… å®Œæ•´éªŒè¯ |
| è¿æ¥é‡è¯• | âŒ æ—  | âœ… è‡ªåŠ¨é‡è¿ |
| å¥åº·æ£€æŸ¥ | âŒ æ—  | âœ… å®šæœŸæ£€æŸ¥ |
| ä¼šè¯ç®¡ç† | âŒ åŸºç¡€ | âœ… å®Œæ•´ç®¡ç† |
| é”™è¯¯å¤„ç† | âŒ ç®€å• | âœ… åˆ†ç±»å¤„ç† |
| ç»Ÿè®¡ç›‘æ§ | âŒ æ—  | âœ… è¯¦ç»†ç»Ÿè®¡ |
| åè®®å¤„ç† | âŒ éƒ¨åˆ† | âœ… å®Œæ•´å¤„ç† |
| éŸ³é¢‘ç¼“å†² | âŒ æ—  | âœ… æ™ºèƒ½ç¼“å†² |

## ğŸ”§ **ä½¿ç”¨ç¤ºä¾‹**

### **1. åŸºæœ¬ä½¿ç”¨**
```python
# åˆ›å»ºSTTå®¢æˆ·ç«¯
stt_client = STTClient(
    app_id="your_app_id",
    token="your_token",
    config=STTConfig(
        sample_rate=16000,
        language="zh-CN",
        enable_interim=True
    )
)

# è¿æ¥å¹¶å¼€å§‹è¯†åˆ«
await stt_client.connect()
await stt_client.start_recognition(
    on_result=lambda text, is_final: print(f"è¯†åˆ«ç»“æœ: {text}"),
    on_error=lambda error: print(f"é”™è¯¯: {error}")
)

# å‘é€éŸ³é¢‘æ•°æ®
await stt_client.send_audio(audio_data)
```

### **2. é«˜çº§åŠŸèƒ½**
```python
# è®¾ç½®å›è°ƒå‡½æ•°
stt_client.set_callbacks(
    on_result=lambda text, is_final: handle_result(text, is_final),
    on_error=lambda error: handle_error(error),
    on_status_change=lambda status: handle_status_change(status)
)

# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = stt_client.get_stats()
print(f"æ€»ä¼šè¯æ•°: {stats['stats']['total_sessions']}")

# å¥åº·æ£€æŸ¥
is_healthy = await stt_client.health_check()
print(f"è¿æ¥å¥åº·: {is_healthy}")
```

## ğŸ¯ **æ”¹è¿›æ€»ç»“**

### **ä¸»è¦æ”¹è¿›ç‚¹**
1. **å®Œæ•´çš„éŸ³é¢‘å¤„ç†** - éªŒè¯ã€ç¼“å†²ã€ç¼–ç 
2. **å¥å£®çš„è¿æ¥ç®¡ç†** - é‡è¿ã€å¥åº·æ£€æŸ¥ã€å¿ƒè·³
3. **å®Œå–„çš„ä¼šè¯ç®¡ç†** - çŠ¶æ€è·Ÿè¸ªã€é…ç½®ç®¡ç†
4. **å¢å¼ºçš„é”™è¯¯å¤„ç†** - åˆ†ç±»å¤„ç†ã€è‡ªåŠ¨æ¢å¤
5. **è¯¦ç»†çš„ç›‘æ§ç»Ÿè®¡** - æ€§èƒ½ç›‘æ§ã€çŠ¶æ€ç»Ÿè®¡
6. **å®Œæ•´çš„åè®®æ”¯æŒ** - æ‰€æœ‰æ¶ˆæ¯ç±»å‹å¤„ç†

### **æŠ€æœ¯ä¼˜åŠ¿**
- **é«˜å¯é æ€§** - è‡ªåŠ¨é‡è¿å’Œé”™è¯¯æ¢å¤
- **é«˜æ€§èƒ½** - æ™ºèƒ½ç¼“å†²å’Œå¼‚æ­¥å¤„ç†
- **æ˜“ç›‘æ§** - è¯¦ç»†çš„ç»Ÿè®¡å’ŒçŠ¶æ€ä¿¡æ¯
- **æ˜“æ‰©å±•** - æ¨¡å—åŒ–è®¾è®¡å’Œé…ç½®ç®¡ç†
- **æ˜“ä½¿ç”¨** - ç®€æ´çš„APIå’Œå›è°ƒæœºåˆ¶

è¿™ä¸ªæ”¹è¿›çš„STTæœåŠ¡ç°åœ¨å…·å¤‡äº†ç”Ÿäº§ç¯å¢ƒæ‰€éœ€çš„æ‰€æœ‰åŠŸèƒ½ï¼Œèƒ½å¤Ÿæä¾›ç¨³å®šã€é«˜æ•ˆçš„è¯­éŸ³è¯†åˆ«æœåŠ¡ã€‚ 