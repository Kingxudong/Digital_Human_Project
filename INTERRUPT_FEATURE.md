# 数字人回答打断功能

## 功能描述

现在当用户输入新内容时，系统会自动打断数字人当前正在进行的回答，让数字人立即开始回答新的问题。

## 实现原理

### 1. 稳定的会话标识

- 使用 `live_id = live_${roomId}_${userId}` 作为稳定的会话标识
- 确保同一个房间内的所有消息和数字人会话使用相同的 `live_id`
- 这样取消机制才能正确找到并取消正在进行的回答

### 2. 取消机制

- 在 `process_query_stream` 函数开始时，检查是否有相同 `live_id` 的正在进行的回答
- 如果有，则调用 `cancel_streams_by_live_id()` 取消所有相关会话
- 取消事件会通过 `asyncio.Event` 传递给正在进行的流式处理

### 3. 流式处理中的取消检查

- 在 LLM 响应流处理过程中，定期检查取消事件
- 在 TTS 音频合成过程中，也支持取消检查
- 一旦检测到取消事件，立即停止处理并返回取消信号

### 4. 前端处理

- 前端接收到 `cancelled` 类型的响应时，显示"正在回答新问题..."的提示
- 然后开始处理新的回答

## 技术细节

### 后端修改

1. **`python_sdk/backend_server.py`**:
   - 在 `process_query_stream` 开始时添加取消逻辑
   - 改进取消函数的日志记录
   - 在流式处理过程中添加取消检查点

2. **会话管理**:
   - `register_stream_session()`: 注册新的流式会话
   - `cancel_streams_by_live_id()`: 通过 live_id 取消会话
   - `cleanup_stream_session()`: 清理会话注册信息

### 前端修改

1. **`src/pages/Meeting/index.tsx`**:
   - 使用 `useMemo` 生成稳定的 `live_id`
   - 修改数字人加入房间时使用相同的 `live_id`
   - 在流式响应处理中添加对 `cancelled` 事件的处理

## 使用场景

1. **快速切换话题**: 用户可以在数字人回答过程中输入新问题
2. **纠正错误**: 如果数字人理解错误，用户可以立即输入正确的问题
3. **提高交互效率**: 减少等待时间，提供更流畅的对话体验

## 测试方法

1. 向数字人发送一个需要较长回答的问题（如"请详细介绍某个复杂话题"）
2. 在数字人开始回答后，立即输入一个新问题
3. 观察数字人是否停止当前回答并开始回答新问题
4. 检查前端是否显示"正在回答新问题..."的提示

## 注意事项

- 取消机制只影响同一房间内的会话
- 不同用户或不同房间的会话不会相互影响
- 取消操作是异步的，可能需要几秒钟才能完全停止当前回答
- 建议在测试时观察后端日志，确认取消机制正常工作
